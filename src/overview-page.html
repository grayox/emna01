<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/iron-icons/notification-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/vaadin-pouchdb/vaadin-pouchdb.html">
<link rel="import" href="item-editor.html">
<link rel="import" href="info-dialog.html">
<link rel="import" href="content-panel.html">
<link rel="import" href="filters-toolbar.html">
<link rel="import" href="moment-js.html">

<!-- Edit -->
<!--- ->
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror.html">
<!---->
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="custom/toolbar-panel.html">
<link rel="import" href="custom/app-behavior.html">
<!-- endEdit -->

<dom-module id="overview-page">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-toolbar {
        background: var(--dark-primary-color);
        --paper-toolbar-content: {
          padding: 0 24px;
        }
      }

      paper-toolbar h1 {
        font-weight: 300;
        font-size: 24px;
      }

      paper-toolbar .logo {
        color: var(--default-primary-color);
        margin-left: 16px;
      }

      .flex {
        flex: 1;
      }

      .content {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        display: flex;
        flex-direction: column;
      }

      @media (min-width: 900px) {
        .content {
          /* Make room for filters panel on the left. */
          padding-left: 308px;
          padding-right: 298px;
        }
      }

      @media (max-width: 1124px) {
        .content {
          padding-right: 0;
        }
      }

      #content-panel {
        flex: 1;
      }

      #sync {
        margin-left: 8px;
        animation: spin 0.8s linear infinite;
      }

      #sync[hidden] {
        display: none;
        animation: none;
      }

      @keyframes spin {
        100% {
          transform: rotate(-360deg);
        }
      }

      .logout-button,
      .about-button {
        font-size: 14px;
        color: var(--primary-color);
      }

      @media (max-width: 600px) {
        paper-toolbar {
          --paper-toolbar-content: {
            padding: 0 6px 0 16px;
          }
        }
        paper-toolbar h1 {
          font-size: 20px;
        }
      }
    </style>
		<!-- Edit -->
    <style>
			paper-icon-button:hover {
				color: var(--paper-grey-500);
				-moz-transition:    .5s;
				-webkit-transition: .5s;
				-o-transition:      .5s;
				transition:         .5s;
			}
    </style>
		<!-- endEdit -->

		<!-- Edit -->
		<!---->
    <firebase-document id="document"
										   app-name="green-comet"
											 xpath="[[editableItemId]]"
											 data="{{editableItem}}"
											 xsequentialTransactions
											 log
											 >
    </firebase-document>
		<!---->
    <firebase-query id="query"
										app-name="green-comet"
										path="/users/[[user.uid]]/items"
										data="{{items}}"
										>
    </firebase-query>
		<!--- ->
		<app-indexeddb-mirror id="indexeddb"
													session="[[user.uid]]"
													key="items"
													data="{{items}}"
													persisted-data="{{persistedItems}}">
    </app-indexeddb-mirror>
		<!--- ->
    <vaadin-pouchdb id="db"
										dbname="{{dbLocal}}"
										remote="{{dbRemote}}"
										data="{{items}}"
										status="{{status}}">
		</vaadin-pouchdb>
		<!---->
    <!-- endEdit -->

    <app-location route="{{route}}"
									use-hash-as-path
									>
		</app-location>
    <app-route route="{{route}}"
							 pattern="/:dbId"
							 data="{{routeData}}"
							 tail="{{subroute}}">
    </app-route>

    <iron-ajax id="ajax"
							 handle-as="json"
							 on-error="_handleBackendError"
							 on-response="_handleBackendResponse">
		</iron-ajax>

    <paper-header-panel>
			
      <paper-toolbar>
				
        <h1>Expense Manager</h1>
				<!--- ->
        <iron-icon id="sync"
									 title="Syncingâ€¦"
									 icon="notification:sync"
									 hidden$="[[_hideSyncIcon(status)]]">
				</iron-icon>
        
				<!---->
        <span class="flex"></span>
        
				<!--- ->
        <paper-button on-tap="_openInfoWindow" class="about-button">Info</paper-button>
        <paper-button on-tap="_logout" class="logout-button">Logout</paper-button>
				<!---->
				<toolbar-panel user="[[user]]"
											 on-logout="_logout"
											 on-info="_openInfoWindow"
											 on-account="_openInfoWindow"
											 on-settings="_openInfoWindow"
											 >
				</toolbar-panel>
				
      </paper-toolbar>
		  
      <div class="content">
        <filters-toolbar id="filters-toolbar"
												 total-owed="[[totalOwed]]"
												 merchants="[[merchants]]"
												 filters="{{filters}}"
												 items="[[items]]"
												 xitems="[[persistedItems]]"
												 >
				</filters-toolbar>
				<content-panel id="content-panel"
											 filters="{{filters}}"
											 total-owed="[[totalOwed]]"
											 items="{{items}}"
											 xitems="{{persistedItems}}"
											 >
				</content-panel>
      </div>

    </paper-header-panel>

		<item-editor id="itemEditor"
								 merchants="[[merchants]]"
								 db="[[_db]]"
								 route="{{subroute}}"
								 item="{{editableItem}}"
                 on-close="commitChange"
								 >								 
		</item-editor>
		
    <paper-toast id="toast"></paper-toast>
    <info-dialog id="info"></info-dialog>
    <iron-localstorage value="{{dbId}}"
											 name="expense-manager-db-id"
											 >
		</iron-localstorage>
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'overview-page',

        properties: {
          //_db: Object,
          route: Object,
          routeData: Object,
          dbLocal: String,
          dbRemote: String,
          dbId: String,
          _showInfo: Boolean,
          loggedIn: {
            type: Boolean,
            notify: true,
            //observer: '_loginStateChanged',
          },
          status: String,
          items: Array,
          totalOwed: Number,
          merchants: Array,
          attachments: Object,
          filters: {
            type: Object,
            notify: true,
            value: function() {
              return {
                start: '',
                end: '',
                merchant: '',
              };
            },
          },
					// Edit
					user: {
            type: Object,
            notify: true,
          },
					// endEdit
        },

				/**/
        listeners: {
          'item-edit'   : '_itemEdit'   ,
          'item-update' : '_itemUpdate' ,
          'item-save'   : '_itemSave'   ,
          'item-delete' : '_itemDelete' ,
        },
				/**/

        observers: [
          '_showInfoDialog(loggedIn, _showInfo)' ,
          '_getUniqueMerchants(items.*)'         ,
          '_calculateTotal(items.*)'             ,
          '_route(route)'                        ,
        ],

        ready: function() {
					/** / // Adding <firebase-query path="[[user.uid]]" data="{{items}}"> causes this error
          Polymer.RenderStatus.afterNextRender(this, function() {
            //this._setupDB();
					  console.log('items', this.items);
          }.bind(this));
          //this._db = this.$.db;
					/**/
        },

        _calculateTotal: function() {
          if (this.items) {
            var total = this.items.filter(function(item) {
                return item.status === 'new';
              }).map(function(item) {
                return item.total;
              })
              .reduce(function(a, b) {
                return a + b;
              }, 0);
            //this.totalOwed = '$' + total.toFixed(2);
          }
        },

        _showInfoDialog: function() {
          if (this.loggedIn && this._showInfo) {
            this.async(function() {
              this._openInfoWindow();
              this._showInfo = false;
            }.bind(this), 1000);
          }
        },

        _openInfoWindow: function() {
					this.$.info.open();
        },

        _getUniqueMerchants: function() {
          if (this.items) {
            this.merchants = this.items.map(function(e) {
              return e.merchant;
            }).filter(function(val, index, self) {
              return self.indexOf(val) === index;
            });
          }
        },

        /** / // Adding <firebase-query path="[[user.uid]]" data="{{items}}"> causes this error
				
        _teardownDB: function() {
          this.dbId = this.dbLocal = this.dbRemote = null;
          this.set('route.path', '');
        },
				
        _setupDB: function() {
          if (this.routeData && this.routeData.dbId) {
            this.dbId = this.routeData.dbId;
          }
          if (this.dbId) {
            this.dbLocal = 'db_' + this.dbId;
            this.set('route.path', '/' + this.dbId);
            this.$.ajax.url = 'https://expense-manager.demo.vaadin.com/api/db/' + this.dbId;
          } else {
            this.$.ajax.url = 'https://expense-manager.demo.vaadin.com/api/create';
          }
          this.$.ajax.generateRequest();
        },
        /** /

        _update: function() {
          //console.log('update');
          this.debounce('update', function() {
            this._db.query();
          }.bind(this), 10);
        },

        _handleBackendResponse: function(e) {
          // jscs:disable requireCamelCaseOrUpperCaseIdentifiers
          var r = e.detail.response;
          if (r && r.backend_db_id) {
            this.dbId = r.backend_db_id;
            this.set('route.path', '/' + this.dbId);

            // Setting these, makes couchdb connect to local & remote DB and start syncing
            this.dbLocal = 'db_' + this.dbId;
            this.dbRemote = r.couchdb_db_url;

            if (r.new_db) {
              this._showInfo = true;
            }

            // We update the entire UI on any change for simplicity.
						/** / // Removing <vaadin-pouchdb> causes this error
            this._db.changes(function() {
              this._update();
            }.bind(this));
						/** /
            // First hit
            this._update();
          } else {
            this.dbId = null;
            this.set('route.path', '');
            //this._setupDB();
          }
        },

        _handleBackendError: function() {
          // Make sure we at least populate from our local DB if the backend is unavailable
          this._update();
        },
				/**/

        _hideSyncIcon: function() {
          return this.status !== 'syncing';
        },

        _itemEdit: function(e) {
          if (e && e.detail) {
            var item = e.detail;
            this.$.itemEditor.open(item); // per Vaadin ExpenseManager
						// This line is changeover from Vaadin ExpenseManager (above) to PolyFire (below)
						//this.edit(item); // per PolyFire
          }
        },

				// Replace save, delete and update functions from ExpenseManager with PolyFire/behavior.html
				/** /
				
        _itemSave: function(e) {
				  /** / // Remove to use <firebase-document>
          var item = e.detail; // This still works; opting for editableItem
					console.log( 'item'           ,              item   );
          this._db.save(data);
					/** /
					// Edit
          var path = 'users/' + this.user.uid;
					var doc = this.$.document;
					console.log( 'editableItem'   , this.editableItem   );
					console.log( 'path'           , path                );
					doc.save(path);
					console.log( 'editableItemId' , this.editableItemId );
					// endEdit
          this.fire('item-update');
        },
				
        _itemDelete: function(e) {
          var item = e.detail;
          this._db.remove(item);
          this.fire('item-update', {
            reason: 'deleted'
          });
        },

        _itemUpdate: function(e) {
          this.$.itemEditor.close();
					var toast = this.$.toast;
          if (e.detail.reason === 'deleted') {
            toast.text = 'Item was deleted';
          } else {
            toast.text = 'Item was saved';
          }
          toast.show();
        },
				/**/

        _logout: function() {
          this.set('loggedIn', false); // Edited: this.loggedIn = false;
        },

				/** /
        _loginStateChanged: function() {
          if (!this.loggedIn) {
            this._teardownDB();
          }
        },
				/**/

        _route: function() {
          var id = this.route.path.replace(/^\//, '');
          if (id && id !== this.dbId) {
            this.set('loggedIn', false); // this.loggedIn = false;
            this.set('loggedIn', true ); // this.loggedIn = true;
          }
        },
				
				// Edit // Source: PolyFire/app.html
				
        behaviors: [
          Polymer.AppBehavior ,
        ],

				get isEditable() {
					return this.online;
				},

				get itemsPath() {
					//return '/items/' + this.user.uid;
					return [ '/users' , this.user.uid , 'items' ].join('/');
				},

				toEditableId: function(itemId) {
					return [ this.itemsPath , itemId ].join('/');
				},
        
				/** /
        signIn: function() {
          this.$.auth.signInWithPopup();
        },
				/**/
				
				// endEdit
				
      });
    })();
  </script>
</dom-module>
